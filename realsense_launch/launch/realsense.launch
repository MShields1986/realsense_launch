<?xml version="1.0" encoding="UTF-8"?>
<launch>
  <arg name="nodelet_manager_name" default="zivid_pipeline_manager" />
  <arg name="rviz" default="true" />
  <arg name="name_space" default="zivid_camera" />
  <arg name="stand_alone" default="true" />

  <arg name="interactive_cropbox" default="false" />
  <arg name="interactive_cropbox_config" default="fixture_1.yaml" />

  <arg name="3D" default="true" />

  <group ns="$(arg name_space)">
    <!-- Nodelet Manager -->
    <node pkg="nodelet" type="nodelet" name="$(arg nodelet_manager_name)" args="manager" />

    <!-- Camera Driver -->
    <node pkg="nodelet" type="nodelet" name="zivid_camera" args="load zivid_camera/nodelet $(arg nodelet_manager_name)" output="screen" />

    <!-- Pointcloud Processing Pipleine -->
    <group if="$(arg 3D)">
      <include file="$(find realsense_launch)/launch/pcl_pipeline.launch">
        <arg name="external_manager" value="true"/>
        <arg name="nodelet_manager_name" value="$(arg nodelet_manager_name)"/>
        <arg name="interactive_cropbox" value="$(arg interactive_cropbox)"/>
        <arg name="input_topic" value="points/xyzrgba"/>
      </include>

      <!-- 737 EC Sample -->
      <!--<param name="crop_box/input_frame" value="pcl_crop_box_1"/>-->
      <!--<param name="crop_box/max_x" value="1.5"/>-->
      <!--<param name="crop_box/max_y" value="0.5"/>-->
      <!--<param name="crop_box/max_z" value="0.4"/>-->

      <!-- Wing Cover UT sample -->
      <param name="crop_box/input_frame" value="pcl_crop_box_2"/>
      <param name="crop_box/max_x" value="2.10"/>
      <param name="crop_box/max_y" value="0.65"/>
      <param name="crop_box/max_z" value="0.45"/>
    </group>

  </group>


  <!-- Interactive Crop Box -->
  <group if="$(arg interactive_cropbox)">
    <include file="$(find pcl_cropbox_setter)/launch/init.launch">
      <arg name="name_space" value="$(arg name_space)"/>
      <arg name="configuration" value="$(arg interactive_cropbox_config)"/>
      <arg name="rviz" value="false"/>
    </include>
  </group>


  <group if="$(arg stand_alone)">
    <!-- Camera Descriptions -->
    <group if="$(eval arg('device_type') == 'd415')">
      <param name="robot_description" command="$(find xacro)/xacro '$(find realsense_launch)/urdf/test_d415_camera.urdf.xacro' use_nominal_extrinsics:=true add_plug:=true use_mesh:=true name_space:=$(arg name_space)" />
    </group>


    <group if="$(eval arg('device_type') == 'd435i')">
      <param name="robot_description" command="$(find xacro)/xacro '$(find realsense_launch)/urdf/test_d435i_camera.urdf.xacro' use_nominal_extrinsics:=true add_plug:=true use_mesh:=true name_space:=$(arg name_space)" />
    </group>

    <group if="$(eval arg('device_type') == 'd435')">
      <param name="robot_description" command="$(find xacro)/xacro '$(find realsense_launch)/urdf/test_d435_camera.urdf.xacro' use_nominal_extrinsics:=true add_plug:=true use_mesh:=true name_space:=$(arg name_space)" />
    </group>


    <!-- Robot State Publisher -->
    <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher" />
  </group>

  <!-- RViz -->
  <group if="$(arg rviz)">
    <node if="$(arg interactive_cropbox)" type="rviz" name="rviz" pkg="rviz" args="-d $(find realsense_launch)/rviz/viewer_interactive_cropbox.rviz" />
    <node unless="$(arg interactive_cropbox)" type="rviz" name="rviz" pkg="rviz" args="-d $(find realsense_launch)/rviz/viewer.rviz" />
  </group>


</launch>
